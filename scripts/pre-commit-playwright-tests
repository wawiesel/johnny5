#!/bin/bash

# Run Playwright end-to-end tests as part of the pre-commit hook.
# Ensures the FastAPI test server and required node/python dependencies exist.

set -euo pipefail

ROOT_DIR=$(cd "$(dirname "$0")/.." && pwd)
cd "$ROOT_DIR"

if ! command -v npx >/dev/null 2>&1; then
    echo "‚ùå Playwright pre-commit: npx not found. Install Node.js / npm first." >&2
    exit 1
fi

if [ ! -d "node_modules" ]; then
    echo "‚ùå Playwright pre-commit: node_modules missing. Run 'npm install' before committing." >&2
    exit 1
fi

if [ ! -x "./venv/bin/uvicorn" ]; then
    echo "‚ùå Playwright pre-commit: ./venv/bin/uvicorn not found or not executable." >&2
    echo "   Create the virtualenv and install Python dependencies before committing." >&2
    exit 1
fi

echo "üé≠ Running Playwright end-to-end tests..."
# Use reporter=line to keep hook output compact.
# Prefer installed playwright if available, fallback to npx
PLAYWRIGHT_CMD=""
if [ -f "$ROOT_DIR/node_modules/.bin/playwright" ]; then
    PLAYWRIGHT_CMD="$ROOT_DIR/node_modules/.bin/playwright"
elif [ -f "$ROOT_DIR/node_modules/@playwright/test/cli.js" ]; then
    PLAYWRIGHT_CMD="node $ROOT_DIR/node_modules/@playwright/test/cli.js"
else
    PLAYWRIGHT_CMD="npx --yes playwright"
fi

# Set timeout to prevent hanging (default 30s per test, config has 15s, webServer has 120s)
# Use cross-platform timeout: macOS uses gtimeout (if installed) or perl alarm, Linux uses timeout
if command -v timeout >/dev/null 2>&1; then
    # Linux: use timeout command
    PLAYWRIGHT_HTML_REPORT=0 timeout 180 $PLAYWRIGHT_CMD test --reporter=line --timeout=30000 || {
        echo "‚ùå Playwright tests failed or timed out"
        exit 1
    }
elif command -v perl >/dev/null 2>&1; then
    # macOS: use perl alarm as timeout
    PLAYWRIGHT_HTML_REPORT=0 perl -e 'alarm 180; exec @ARGV' $PLAYWRIGHT_CMD test --reporter=line --timeout=30000 || {
        echo "‚ùå Playwright tests failed or timed out"
        exit 1
    }
else
    # Fallback: rely on Playwright's own timeout and webServer timeout (120s)
    PLAYWRIGHT_HTML_REPORT=0 $PLAYWRIGHT_CMD test --reporter=line --timeout=30000 || {
        echo "‚ùå Playwright tests failed"
        exit 1
    }
fi
echo "‚úÖ Playwright tests passed"
