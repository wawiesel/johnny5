#!/bin/bash

set -euo pipefail

ROOT_DIR=$(cd "$(dirname "$0")/.." && pwd)
VENV_BIN="$ROOT_DIR/venv/bin"

echo "üß™ Python checks (pytest, ruff, mypy)"

if [ ! -x "$VENV_BIN/python" ]; then
  echo "‚ùå Python venv not found at $VENV_BIN"
  echo "   Create it and install dev deps: python3 -m venv venv && venv/bin/pip install -U pip pytest ruff mypy"
  exit 1
fi

# Ensure dev extras (pytest, ruff, mypy, httpx, etc.) are available
if ! "$VENV_BIN/python" -c "import httpx" >/dev/null 2>&1; then
  echo "‚¨áÔ∏è  Installing python dev dependencies (editable w/ dev extras)"
  "$VENV_BIN/pip" install -e ".[dev]"
fi

for tool in pytest ruff mypy; do
  if [ ! -x "$VENV_BIN/$tool" ]; then
    echo "‚ùå Required tool missing in venv: $tool"
    echo "   Install with: $VENV_BIN/pip install -e '.[dev]'"
    exit 1
  fi
done

echo "‚ñ∂ Pytest"
cd "$ROOT_DIR"
"$VENV_BIN/python" -m pytest -q
echo "‚úÖ Pytest passed"

echo "‚ñ∂ Ruff"
"$VENV_BIN/ruff" check .
echo "‚úÖ Ruff passed"

echo "‚ñ∂ mypy"
"$VENV_BIN/mypy" src tests
echo "‚úÖ mypy passed"

exit 0


